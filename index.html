<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>নিউ কর্ণফুলী টাইলস্ এন্ড সেনিটারী - Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root { 
      --sidebar-bg: #0f172a; 
      --sidebar-hover: #1e293b;
      --accent: #3b82f6; 
      --body-bg: #f1f5f9; 
    }
    body { font-family: 'Hind Siliguri', sans-serif; background-color: var(--body-bg); margin: 0; }

    #loginPage { height: 100vh; display: flex; align-items: center; justify-content: center; background: #ffffff; }
    .login-box { background: #ffffff; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); width: 100%; max-width: 400px; text-align: center; border: 1px solid #eee; }
    .login-box h2 { font-weight: 700; color: #333; margin-bottom: 25px; }
    .form-control { border-radius: 10px; padding: 12px; border: 1px solid #ddd; margin-bottom: 15px; }
    .btn-login { background: var(--accent); color: white; border-radius: 10px; padding: 12px; width: 100%; border: none; font-weight: 600; }

    .sidebar { width: 260px; height: 100vh; background: var(--sidebar-bg); position: fixed; color: white; z-index: 1000; box-shadow: 4px 0 10px rgba(0,0,0,0.1); }
    .sidebar-menu a { padding: 14px 25px; display: flex; align-items: center; color: #94a3b8; text-decoration: none; cursor: pointer; transition: 0.3s; border-left: 4px solid transparent; }
    .sidebar-menu a:hover, .sidebar-menu a.active { background: var(--sidebar-hover); color: #fff; border-left: 4px solid var(--accent); }
    .sidebar-menu a i { margin-right: 12px; font-size: 18px; }
    
    .main-content { margin-left: 260px; padding: 30px; }
    .hidden { display: none !important; }
    .card { border: none; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; overflow: hidden; }
    
    .form-card { background: #fff; border-top: 5px solid var(--accent); }
    .input-group-text { background: #f8fafc; border-right: none; color: #64748b; }
    .entry-input { border-left: none; font-weight: 600; }
    .entry-input:focus { box-shadow: none; border-color: #ddd; }

    .stat-card { padding: 20px; text-align: center; border-bottom: 4px solid var(--accent); }
    .stat-card h5 { color: #64748b; font-size: 14px; }
    .stat-card h3 { font-weight: 700; margin-top: 5px; }
    .chart-box { background: white; padding: 20px; border-radius: 15px; margin-top: 20px; height: 400px; }
  </style>
</head>
<body>

<div id="loginPage">
  <div class="login-box">
    <i class="fas fa-user-shield fa-4x text-primary mb-3"></i>
    <h2> নিউ কর্ণফুলী টাইলস্ এন্ড সেনিটারী </h2>
     <h3>সিস্টেম লগইন</h3>
    <input type="text" id="user" class="form-control" placeholder="ইউজার আইডি">
    <input type="password" id="pass" class="form-control" placeholder="পাসওয়ার্ড">
    <button onclick="login()" id="loginBtn" class="btn-login">প্রবেশ করুন</button>
    <div id="errMsg" class="text-danger mt-3 small fw-bold"></div>
  </div>
</div>

<div id="dashboardSection" class="hidden">
  <div class="sidebar">
    <div class="p-4 text-center border-bottom border-secondary mb-3">
      <h4 class="fw-bold mb-0">TilePro <span class="text-primary">Admin</span></h4>
    </div>
    <div class="sidebar-menu">
      <a onclick="showPage('dailyPage')" id="linkDaily" class="active"><i class="fas fa-edit"></i>দৈনিক আয়-ব্যয় </a>
      <a onclick="showPage('monthlyPage')" id="linkMonthly"><i class="fas fa-file-invoice-dollar"></i>মাসিক খরচ এন্ট্রি </a>
      <a onclick="showPage('reportPage')" id="linkReport"><i class="fas fa-chart-pie"></i> মাসিক আয়-ব্যয় রিপোর্ট </a>
      <a onclick="showPage('yearlyAnalysisPage')" id="linkYearlyAnalysis"><i class="fas fa-analytics"></i>বার্ষিক বিশ্লেষণ</a>
      <a onclick="logout()" class="text-danger mt-5"><i class="fas fa-power-off"></i>লগআউট</a>
    </div>
  </div>

  <div class="main-content">
    <div id="dailyPage">
      <h3 class="fw-bold mb-4 text-dark"><i class="fas fa-plus-circle text-primary me-2"></i>দৈনিক আয়-ব্যয় হিসাব এন্ট্রি</h3>
      <div class="card form-card p-4" style="max-width: 700px;">
        <div class="row g-3">
          <div class="col-md-12">
            <label class="small fw-bold text-secondary">লেনদেনের তারিখ</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
              <input type="date" id="date" class="form-control entry-input">
            </div>
          </div>
          <div class="col-md-6">
            <label class="small fw-bold text-secondary">মোট বিক্রয় (৳)</label>
            <div class="input-group">
              <span class="input-group-text">৳</span>
              <input type="number" id="sales" class="form-control entry-input" placeholder="0.00">
            </div>
          </div>
          <div class="col-md-6">
            <label class="small fw-bold text-secondary">দৈনিক নিট লাভ (৳)</label>
            <div class="input-group">
              <span class="input-group-text">৳</span>
              <input type="number" id="profit" class="form-control entry-input" placeholder="0.00">
            </div>
          </div>
          <div class="col-md-6">
            <label class="small fw-bold text-secondary">চা-নাস্তা/অন্যান্য খরচ (৳)</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-coffee"></i></span>
              <input type="number" id="expense" class="form-control entry-input" placeholder="0.00">
            </div>
          </div>
          <div class="col-md-6">
            <label class="small fw-bold text-secondary">লেবার বিল (৳)</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-users"></i></span>
              <input type="number" id="labor" class="form-control entry-input" placeholder="0.00">
            </div>
          </div>
          <div class="col-12 mt-4">
            <button onclick="saveData()" id="saveBtn" class="btn btn-primary w-100 py-2 fw-bold shadow-sm">
              <i class="fas fa-save me-2"></i>ডাটা সেভ করুন
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="monthlyPage" class="hidden">
      <h3 class="fw-bold mb-4 text-danger"><i class="fas fa-wallet me-2"></i>মাসিক ফিক্সড খরচ এন্ট্রি</h3>
      <div class="card p-4 form-card border-danger" style="max-width: 650px;">
        <select id="mMonth" class="form-select mb-3 fw-bold bg-light">
            <option value="January_2025">জানুয়ারি ২০২৫</option><option value="February_2025">ফেব্রুয়ারি ২০২৫</option>
            <option value="March_2025">মার্চ ২০২৫</option><option value="April_2025">এপ্রিল ২০২৫</option>
            <option value="May_2025">মে ২০২৫</option><option value="June_2025">জুন ২০২৫</option>
            <option value="July_2025">জুলাই ২০২৫</option><option value="August_2025">আগস্ট ২০২৫</option>
            <option value="September_2025">সেপ্টেম্বর ২০২৫</option><option value="October_2025">অক্টোবর ২০২৫</option>
            <option value="November_2025">নভেম্বর ২০২৫</option><option value="December_2025">ডিসেম্বর ২০২৫</option>
        </select>
        <div class="row g-2">
          <div class="col-md-6"><input type="number" id="fShop" class="form-control" placeholder="দোকান ভাড়া"></div>
          <div class="col-md-6"><input type="number" id="fGodown" class="form-control" placeholder="গোডাউন ভাড়া"></div>
          <div class="col-md-6"><input type="number" id="fSalary" class="form-control" placeholder="ম্যানেজার বেতন"></div>
          <div class="col-md-6"><input type="number" id="fElec" class="form-control" placeholder="বিদ্যুৎ বিল"></div>
          <div class="col-md-6"><input type="number" id="fWifi" class="form-control" placeholder="ওয়াইফাই বিল"></div>
          <div class="col-md-6"><input type="number" id="fReturn" class="form-control" placeholder="মাল ফেরত (৳)"></div>
          <div class="col-12"><input type="number" id="fOther" class="form-control" placeholder="অতিরিক্ত খরচ"></div>
          <button onclick="saveMonthly()" class="btn btn-danger w-100 mt-2 fw-bold shadow-sm">মাসিক হিসাব আপডেট করুন</button>
        </div>
      </div>
    </div>

    <div id="reportPage" class="hidden">
      <div class="d-flex justify-content-between mb-4">
        <h3 class="fw-bold">মাসিক লাভ-ক্ষতি রিপোর্ট</h3>
        <div>
          <button id="editMonthlyBtn" onclick="goToEditMonthly()" class="btn btn-warning btn-sm px-3 fw-bold me-2 hidden">
            <i class="fas fa-edit me-1"></i>Edit Monthly Expense
          </button>
          <button onclick="downloadPDF()" class="btn btn-dark btn-sm px-4">PDF ডাউনলোড</button>
        </div>
      </div>
      <div class="card p-3 mb-4">
          <label class="small fw-bold mb-2">মাস নির্বাচন করুন:</label>
          <select id="reportMonth" class="form-select" style="max-width: 250px;" onchange="initDashboard()">
            <option value="January_2025">জানুয়ারি ২০২৫</option><option value="February_2025">ফেব্রুয়ারি ২০২৫</option>
            <option value="March_2025">মার্চ ২০২৫</option><option value="April_2025">এপ্রিল ২০২৫</option>
            <option value="May_2025">মে ২০২৫</option><option value="June_2025">জুন ২০২৫</option>
            <option value="July_2025">জুলাই ২০২৫</option><option value="August_2025">আগস্ট ২০২৫</option>
            <option value="September_2025">সেপ্টেম্বর ২০২৫</option><option value="October_2025">অক্টোবর ২০২৫</option>
            <option value="November_2025">নভেম্বর ২০২৫</option><option value="December_2025">ডিসেম্বর ২০২৫</option>
          </select>
      </div>
      <div id="printableArea">
        <div class="row g-3 mb-4" id="statSummary"></div>
        <div class="card p-4">
          <h5 class="fw-bold border-bottom pb-2">লেনদেন তালিকা</h5>
          <div class="table-responsive">
            <table class="table table-hover text-center align-middle">
              <thead class="table-light">
                <tr><th>তারিখ</th><th>বিক্রয়</th><th>লাভ</th><th>খরচ</th><th>লেবার</th><th>এডিট</th></tr>
              </thead>
              <tbody id="ledgerBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div id="yearlyAnalysisPage" class="hidden">
      <h3 class="fw-bold mb-4">বার্ষিক লাভ-বিক্রয় বিশ্লেষণ</h3>
      <div class="row g-3 mb-4">
        <div class="col-md-6"><div class="card stat-card border-primary"><h5>সর্বোচ্চ বিক্রয় মাস</h5><h3 id="bestSalesMonth">-</h3></div></div>
        <div class="col-md-6"><div class="card stat-card border-success"><h5>সর্বোচ্চ লাভের মাস</h5><h3 id="bestProfitMonth">-</h3></div></div>
      </div>
      <div class="chart-box card border-0">
        <canvas id="yearlyChart"></canvas>
      </div>
    </div>
  </div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxOIjOpoErSoZpVqTnH9SyqtUdKPCa9Zn6KmfTDxJPU3JvMgW4aQtP7d-Kl3z0-B80E/exec";
let userRole = "";

window.onload = function() {
  const session = localStorage.getItem("tileProSession");
  if(session) {
    userRole = session;
    document.getElementById('loginPage').classList.add('hidden');
    document.getElementById('dashboardSection').classList.remove('hidden');
    if(userRole === "PARTNER") {
        document.getElementById('linkDaily').classList.add('hidden');
        document.getElementById('linkMonthly').classList.add('hidden');
    }
    showPage('dailyPage');
  }
}

function login() {
  const u = document.getElementById('user').value;
  const p = document.getElementById('pass').value;
  const btn = document.getElementById('loginBtn');
  btn.innerText = "চেক করা হচ্ছে...";
  
  fetch(`${SCRIPT_URL}?action=login&user=${u}&pass=${p}`)
    .then(res => res.json()).then(res => {
      if(res.success) {
        userRole = res.role;
        localStorage.setItem("tileProSession", userRole);
        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('dashboardSection').classList.remove('hidden');
        if(userRole === "PARTNER") {
          document.getElementById('linkDaily').classList.add('hidden');
          document.getElementById('linkMonthly').classList.add('hidden');
          showPage('reportPage');
        } else {
          showPage('dailyPage');
        }
      } else {
        document.getElementById('errMsg').innerText = "আইডি বা পাসওয়ার্ড ভুল!";
        btn.innerText = "প্রবেশ করুন";
      }
    });
}

function logout() {
    localStorage.removeItem("tileProSession");
    location.reload();
}

function showPage(pageId) {
  ['dailyPage', 'monthlyPage', 'reportPage', 'yearlyAnalysisPage'].forEach(id => document.getElementById(id).classList.add('hidden'));
  document.getElementById(pageId).classList.remove('hidden');
  document.querySelectorAll('.sidebar-menu a').forEach(a => a.classList.remove('active'));
  
  let linkId = 'link' + pageId.charAt(0).toUpperCase() + pageId.slice(1);
  if(pageId === 'reportPage') linkId = 'linkReport';
  if(document.getElementById(linkId)) document.getElementById(linkId).classList.add('active');

  if(pageId === 'reportPage') initDashboard();
  if(pageId === 'yearlyAnalysisPage') initYearlyAnalysis();
}

// রিপোর্ট থেকে মাসিক খরচ এডিট পেজে যাওয়ার ফাংশন
function goToEditMonthly() {
  const selectedMonth = document.getElementById('reportMonth').value;
  document.getElementById('mMonth').value = selectedMonth;
  showPage('monthlyPage');
}

function initDashboard() {
  const m = document.getElementById('reportMonth').value;
  const tbody = document.getElementById('ledgerBody');
  const editMBtn = document.getElementById('editMonthlyBtn');
  
  // পার্টনার হলে এডিট বাটন হাইড থাকবে
  if(userRole !== "PARTNER") editMBtn.classList.remove('hidden');

  tbody.innerHTML = '<tr><td colspan="6">লোড হচ্ছে...</td></tr>';

  fetch(`${SCRIPT_URL}?action=getSummary&month=${m}`)
    .then(res => res.json()).then(data => {
      const stats = `
        <div class="col-md-2"><div class="card stat-card"><h5>বিক্রয়</h5><h3>৳${data.thisMonthSales}</h3></div></div>
        <div class="col-md-2"><div class="card stat-card"><h5>লেবার</h5><h3>৳${data.totalLabor}</h3></div></div>
        <div class="col-md-2"><div class="card stat-card"><h5>মাল ফেরত</h5><h3>৳${data.totalReturns}</h3></div></div>
        <div class="col-md-2"><div class="card stat-card"><h5>স্থায়ী খরচ</h5><h3>৳${data.fixedTotal}</h3></div></div>
        <div class="col-md-2"><div class="card stat-card text-success"><h5>নিট লাভ</h5><h3>৳${data.netProfit}</h3></div></div>
        <div class="col-md-2"><div class="card stat-card text-primary"><h5>পার্টনার ভাগ</h5><h3>৳${data.partnerShare}</h3></div></div>`;
      document.getElementById('statSummary').innerHTML = stats;
      
      let html = "";
      data.rawRows.forEach((r, i) => {
        html += `<tr id="row-${i}">
          <td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td>${r[4]}</td>
          <td><button class="btn btn-sm btn-outline-primary" onclick="editRow(${i}, '${r[0]}', ${r[1]}, ${r[2]}, ${r[3]}, ${r[4]})"><i class="fas fa-edit"></i></button></td>
        </tr>`;
      });
      tbody.innerHTML = html;
    });
}

let myChart = null;
function initYearlyAnalysis() {
    fetch(`${SCRIPT_URL}?action=getYearlyData`)
    .then(res => res.json()).then(data => {
        document.getElementById('bestSalesMonth').innerText = data.bestSalesMonth;
        document.getElementById('bestProfitMonth').innerText = data.bestProfitMonth;
        const ctx = document.getElementById('yearlyChart').getContext('2d');
        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [
                    { label: 'বিক্রয় (৳)', data: data.sales, backgroundColor: '#3b82f6' },
                    { label: 'নিট লাভ (৳)', data: data.profits, backgroundColor: '#10b981' }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } }
            }
        });
    });
}

function editRow(index, date, sales, profit, exp, labor) {
  const row = document.getElementById(`row-${index}`);
  row.innerHTML = `
    <td>${date}</td>
    <td><input type="number" id="edit-s-${index}" style="width:80px" value="${sales}"></td>
    <td><input type="number" id="edit-p-${index}" style="width:80px" value="${profit}"></td>
    <td><input type="number" id="edit-e-${index}" style="width:80px" value="${exp}"></td>
    <td><input type="number" id="edit-l-${index}" style="width:80px" value="${labor}"></td>
    <td><button class="btn btn-sm btn-success" onclick="updateRow(${index}, '${date}')">Save</button></td>`;
}

function updateRow(index, date) {
  const data = { action: "editEntry", date: date, sales: document.getElementById(`edit-s-${index}`).value, dailyProfit: document.getElementById(`edit-p-${index}`).value, expense: document.getElementById(`edit-e-${index}`).value, labor: document.getElementById(`edit-l-${index}`).value, month: document.getElementById('reportMonth').value };
  fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(data) }).then(() => { alert("আপডেট হয়েছে!"); initDashboard(); });
}

function saveData() {
  const data = { action: "addEntry", date: document.getElementById('date').value, sales: document.getElementById('sales').value, dailyProfit: document.getElementById('profit').value, expense: document.getElementById('expense').value, labor: document.getElementById('labor').value, role: userRole };
  fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(data) }).then(() => { 
    alert("সেভ হয়েছে!"); 
    // ক্লিয়ার ইনপুট
    document.getElementById('sales').value = '';
    document.getElementById('profit').value = '';
    document.getElementById('expense').value = '';
    document.getElementById('labor').value = '';
    initDashboard(); 
  });
}

function saveMonthly() {
  const data = { action: "addFixedExpense", month: document.getElementById('mMonth').value, shopRent: document.getElementById('fShop').value, godownRent: document.getElementById('fGodown').value, salary: document.getElementById('fSalary').value, electric: document.getElementById('fElec').value, wifi: document.getElementById('fWifi').value, returns: document.getElementById('fReturn').value, others: document.getElementById('fOther').value };
  fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(data) }).then(() => {
    alert("মাসিক খরচ সেভ/আপডেট হয়েছে!");
    showPage('reportPage'); // সেভ হওয়ার পর আবার রিপোর্টে নিয়ে যাবে
  });
}

function downloadPDF() {
  const element = document.getElementById('printableArea');
  html2pdf().from(element).save('Monthly_Report.pdf');
}
</script>
</body>
</html>